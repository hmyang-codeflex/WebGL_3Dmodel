<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Babylon 3D ë·°ì–´ - Toolbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      height:100%; margin:0;
      background:#f4f6fb; color:#222; font-family:'Segoe UI', 'Roboto', 'Apple SD Gothic Neo', 'Noto Sans KR', Arial, sans-serif;
    }
    #sidebar {
      position:fixed; 
      left:0; top:0; 
      width:100%; 
      height:100%;
      background:#f4f6fb; 
      overflow:auto; 
      padding:18px 16px;
      display:flex; 
      flex-direction:column; 
      gap:18px;
    }
    .panel {
      border:1px solid #e3e7ee; border-radius:16px; padding:18px 14px; background:#fff;
      display:flex; flex-direction:column; gap:12px;
      box-shadow:0 2px 8px 0 rgba(60,80,120,0.04);
    }
    .panel h3 {
      margin:0 0 10px 0; font-size:15px; font-weight:600; color:#3a4153; opacity:1;
    }
    .row {
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    .btn {
      border:none; border-radius:8px; padding:8px 14px; background:#e3e7ee; color:#3a4153; cursor:pointer;
      font-weight:500; font-size:14px; transition:background .15s;
      box-shadow:0 1px 4px 0 rgba(60,80,120,0.04);
    }
    .btn.small { padding:5px 10px; font-size:12px; }
    .btn:hover { background:#d0d6e2; color:#222; }
    .input {
      background:#f7f8fa; border:1px solid #e3e7ee; border-radius:8px; color:#222; padding:7px 10px;
      font-size:14px;
    }
    label.inline { display:inline-flex; align-items:center; gap:7px; font-size:13px; color:#3a4153; }
    input[type=color]{ width:36px; height:28px; border:1px solid #e3e7ee; border-radius:8px; background:#f7f8fa; }
    .item {
      border:1px solid #e3e7ee; border-radius:12px; padding:10px; background:#f7f8fa;
      box-shadow:0 1px 4px 0 rgba(60,80,120,0.04);
    }
    .nameLine { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .name { font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px; color:#3a4153; }
    .stepRow { display:flex; gap:6px; flex-wrap:wrap; }
    #file { display:none; }
    .note { font-size:12px; color:#7a869a; margin-top:4px; }
    #sidebar::-webkit-scrollbar { width:8px; background:#e3e7ee; }
    #sidebar::-webkit-scrollbar-thumb { background:#d0d6e2; border-radius:8px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <!-- íŒì—… ëª¨ë“œ í—¤ë” -->
    <div id="popupHeader" class="panel" style="display:none;">
      <h3>ğŸ› ï¸ 3D ë·°ì–´ ì„¤ì •</h3>
      <div style="font-size:12px;color:#7a869a;">ì´ ì°½ì—ì„œ 3D ëª¨ë¸ì˜ ëª¨ë“  ì„¤ì •ì„ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>
    
    <!-- ì„ íƒëœ ëª¨ë¸ ì •ë³´ íŒ¨ë„ (ë™ì  ìƒì„±) -->
    
    <!-- Material (Texture) Editor Panel -->
    <div class="panel" id="matPanel">
      <h3>ì¬ì§ˆ(ì§ˆê°) í¸ì§‘</h3>
      <div class="row">
        <label class="inline">ì¬ì§ˆ ì„ íƒ</label>
        <select id="matSelect" class="input" style="flex:1"></select>
        <button id="matRefresh" class="btn small">ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <div class="row">
        <label class="inline">Base Color</label>
        <input type="color" id="baseColor" value="#cccccc" />
        <label class="inline">Alpha</label>
        <input type="range" id="alpha" min="0" max="1" step="0.01" value="1" style="width:120px"/>
      </div>

      <div class="row">
        <label class="inline">Metallic</label>
        <input type="range" id="metallic" min="0" max="1" step="0.01" value="0.0" style="width:180px"/>
      </div>

      <div class="row">
        <label class="inline">Roughness</label>
        <input type="range" id="roughness" min="0" max="1" step="0.01" value="0.9" style="width:180px"/>
      </div>

      <div class="row">
        <label class="inline">Emissive</label>
        <input type="color" id="emissiveColor" value="#000000" />
        <input type="range" id="emissiveIntensity" min="0" max="5" step="0.05" value="0" style="width:120px"/>
      </div>

      <div class="row">
        <label class="inline">Double Sided</label>
        <input type="checkbox" id="doubleSided"/>
        <label class="inline">AlphaMode</label>
        <select id="alphaMode" class="input">
          <option value="OPAQUE">OPAQUE</option>
          <option value="MASK">MASK</option>
          <option value="BLEND">BLEND</option>
        </select>
        <label class="inline">Cutoff</label>
        <input type="range" id="alphaCutoff" min="0" max="1" step="0.01" value="0.5" style="width:100px"/>
      </div>

      <div class="row">
        <label class="inline">BaseColor Tex</label>
        <input type="file" id="texBase" accept=".png,.jpg,.jpeg,.webp" />
        <button id="texBaseClear" class="btn small">x</button>
      </div>
      <div class="row">
        <label class="inline">Normal Tex</label>
        <input type="file" id="texNormal" accept=".png,.jpg,.jpeg,.webp" />
        <label class="inline">ê°•ë„</label>
        <input type="range" id="normalLevel" min="0" max="2" step="0.05" value="1" style="width:100px"/>
        <button id="texNormalClear" class="btn small">x</button>
      </div>
      <div class="row">
        <label class="inline">Metallic/Roughness Tex</label>
        <input type="file" id="texMR" accept=".png,.jpg,.jpeg,.webp" />
        <label class="inline"><input type="checkbox" id="useMRPack" checked /> glTF ì±„ë„(G/B)</label>
        <button id="texMRClear" class="btn small">x</button>
      </div>
      <div class="row">
        <label class="inline">AO Tex</label>
        <input type="file" id="texAO" accept=".png,.jpg,.jpeg,.webp" />
        <button id="texAOClear" class="btn small">x</button>
      </div>
      <div class="row">
        <label class="inline">Emissive Tex</label>
        <input type="file" id="texEmissive" accept=".png,.jpg,.jpeg,.webp" />
        <button id="texEmissiveClear" class="btn small">x</button>
      </div>

      <div class="note">â€¢ URDF ê¸°ë°˜ GLBëŠ” ë³´í†µ í…ìŠ¤ì²˜ê°€ ì—†ì–´ìš”. ì—¬ê¸°ì„œ ì¬ì§ˆ/í…ìŠ¤ì²˜ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶™ì—¬ì„œ ì§ˆê° í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
    </div>

    <!-- Sunlight Panel -->
    <div class="panel" id="lightPanelSun">
      <h3>íƒœì–‘ê´‘ (Sun)</h3>
      <div class="row">
        <label class="inline">ì‚¬ìš© <input type="checkbox" id="sunToggle"></label>
        <label class="inline">ë°ê¸° <input id="sunIntensity" class="input" type="range" min="0" max="4" step="0.05" value="1.5" style="width:140px"></label>
      </div>
      <div class="row">
        <label class="inline">ë°©ìœ„ê°Â° <input id="sunAzimuth" type="range" min="0" max="360" step="1" value="135" style="width:160px"></label>
      </div>
      <div class="row">
        <label class="inline">ê³ ë„Â° <input id="sunAltitude" type="range" min="-5" max="85" step="1" value="35" style="width:160px"></label>
      </div>
      <div class="row">
        <label class="inline">ê·¸ë¦¼ì <input type="checkbox" id="sunShadows" checked></label>
      </div>
      <div class="note">0Â°= +X(ë™), 90Â°= +Z(ë¶). ê³ ë„ëŠ” ì§€í‰ì„  ê¸°ì¤€.</div>
    </div>

    <!-- Light Control Panel (basic) -->
    <div class="panel" id="lightPanelBasic">
      <h3>ì¡°ëª…</h3>
      <div class="row">
        <label class="inline">Hemi ì‚¬ìš© <input type="checkbox" id="hemiToggle" checked></label>
        <label class="inline">ë°ê¸° <input id="hemiIntensity" class="input" type="range" min="0" max="2" step="0.05" value="0.7" style="width:140px"></label>
      </div>
      <div class="row">
        <label class="inline">Directional ì‚¬ìš© <input type="checkbox" id="dirToggle" checked></label>
        <label class="inline">ë°ê¸° <input id="dirIntensity" class="input" type="range" min="0" max="2" step="0.05" value="1.0" style="width:140px"></label>
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <label class="btn">ëª¨ë¸ ì—´ê¸°
          <input id="file" type="file" accept=".glb,.gltf,.GLB,.GLTF,.bin,.png,.jpg,.jpeg" multiple/>
        </label>
        <button id="sceneReset" class="btn small">ì”¬ ë¦¬ì…‹</button>
        <button id="screenshot" class="btn small">ìŠ¤í¬ë¦°ìƒ·</button>
      </div>
      <div class="row">
        <button id="modeMove" class="btn small">Move (W)</button>
        <button id="modeRot"  class="btn small">Rotate (E)</button>
        <button id="modeScl"  class="btn small">Scale (R)</button>
        <button id="spaceBtn" class="btn small">Space: Local</button>
        <button id="centerBtn" class="btn small">í”¼ë²— ì¬ì¤‘ì•™(C)</button>
      </div>
      <div class="row">
        <div>íšŒì „Â°</div><input id="rotStep" class="input" type="number" step="1" value="5" style="width:70px">
        <div>ì´ë™</div><input id="posStep" class="input" type="number" step="0.001" value="0.01" style="width:70px">
        <div>ê²€ìƒ‰</div><input id="search" class="input" placeholder="ë…¸ë“œ/ì¡°ì¸íŠ¸ ì´ë¦„" style="flex:1">
      </div>
      <div style="font-size:12px;opacity:.85">ë”ë¸”í´ë¦­=ì„ íƒ Â· L=Local/World Â· F=í¬ì»¤ìŠ¤ Â· C=í”¼ë²— ì¬ì¤‘ì•™</div>
    </div>

    <div class="panel">
      <h3>ìŠ¤íƒ€ì¼/íš¨ê³¼</h3>
      <div class="row" style="gap:14px; align-items:center;">
        <label class="inline">ìœ¤ê³½ì„  <input type="checkbox" id="useOutline" checked></label>
        <label class="inline">í­ <input id="outlineWidth" class="input" type="number" step="0.005" value="0.02" style="width:70px"></label>
        <label class="inline">ìƒ‰ <input id="outlineColor" type="color" value="#111827"></label>
      </div>
      <div class="row" style="gap:14px; align-items:center;">
        <label class="inline">ì—ì§€ì„  <input type="checkbox" id="useEdges" checked></label>
        <label class="inline">í­ <input id="edgesWidth" class="input" type="number" step="1" value="15" style="width:70px"></label>
        <label class="inline">ìƒ‰ <input id="edgesColor" type="color" value="#000000"></label>
      </div>
      <div class="row" style="gap:14px; align-items:center;">
        <label class="inline">ì™€ì´ì–´í”„ë ˆì„ <input type="checkbox" id="useWire"></label>
        <label class="inline">ì–‘ë©´í‘œì‹œ <input type="checkbox" id="useDouble"></label>
        <label class="inline">í•˜ì´ë¼ì´íŠ¸ <input type="checkbox" id="useHL"></label>
      </div>
      <div class="row" style="gap:8px">
        <button id="applyStyleBtn" class="btn small">ìŠ¤íƒ€ì¼ ì ìš©</button>
        <button id="resetStyleBtn" class="btn small">ìŠ¤íƒ€ì¼ ì›ë³µ</button>
      </div>
      <div class="row" style="gap:14px; align-items:center; margin-top:8px;">
        <label class="inline">ë°°ê²½ìƒ‰ìƒ <input id="bgColorPicker" type="color" value="#0f1115"></label>
      </div>
      <div class="row" style="gap:14px; align-items:center; margin-top:8px;">
        <label class="inline">ê·¸ë¦¬ë“œ ì„ ìƒ‰ <input id="gridLineColorPicker" type="color" value="#3a4153"></label>
        <label class="inline">ê·¸ë¦¬ë“œ ë°°ê²½ <input id="gridMainColorPicker" type="color" value="#232531"></label>
        <label class="inline">ê·¸ë¦¬ë“œ í¬ê¸° <input id="gridSizeInput" type="number" min="1" max="100" value="10" style="width:70px"></label>
      </div>
    </div>

    <div class="panel">
      <h3>ë³´ê¸°</h3>
      <div class="row">
        <label class="inline">ê·¸ë¦¬ë“œ í‘œì‹œ <input type="checkbox" id="gridVis" checked></label>
        <label class="inline">ë‹¨ìœ„ ë³€í™˜
          <select id="unitSelect" class="input">
            <option value="auto">ìë™</option>
            <option value="m">ë¯¸í„°(m)</option>
            <option value="mm">ë°€ë¦¬ë¯¸í„°(mm)</option>
            <option value="none">ì›ë³¸ ìœ ì§€</option>
          </select>
        </label>
      </div>
      <div class="row">
        <button id="fitBtn" class="btn small">ë·° ë§ì¶”ê¸°</button>
        <button id="inspectorBtn" class="btn small">ì¸ìŠ¤í™í„°</button>
      </div>
    </div>

    <div id="list"></div>
  </div>

  <script>
    /*
    =================================================================
                    WebGL 3D ë·°ì–´ - íˆ´ë°•ìŠ¤ (ì„¤ì • ì œì–´íŒ)
    =================================================================
    ê¸°ëŠ¥: ì¬ì§ˆ í¸ì§‘, ì¡°ëª… ì œì–´, ìŠ¤íƒ€ì¼ ì„¤ì •, ëª¨ë¸ ì •ë³´ í‘œì‹œ
    í†µì‹ : postMessageë¡œ 3D ë·°ì–´ì™€ ì—°ë™
    ì €ì¥: localStorageë¡œ ì„¤ì • ì§€ì†ì„± ë³´ì¥
    =================================================================
    */
    
    // ===== localStorage ìœ í‹¸ë¦¬í‹° =====
    function getLS(key, def) {
      try { const v = localStorage.getItem(key); return v !== null ? v : def; } catch(e) { return def; }
    }
    function setLS(key, val) {
      try { localStorage.setItem(key, val); } catch(e) {}
    }

    // ì´ˆê¸°ê°’ ë³µì›
    function restoreSettings() {
      const $ = id => document.getElementById(id);
      
      // ìŠ¤íƒ€ì¼ ì„¤ì •
      $('useOutline').checked = getLS('useOutline', 'true') === 'true';
      $('outlineWidth').value = getLS('outlineWidth', '0.02');
      $('outlineColor').value = getLS('outlineColor', '#111827');
      $('useEdges').checked = getLS('useEdges', 'true') === 'true';
      $('edgesWidth').value = getLS('edgesWidth', '15');
      $('edgesColor').value = getLS('edgesColor', '#000000');
      $('useWire').checked = getLS('useWire', 'false') === 'true';
      $('useDouble').checked = getLS('useDouble', 'false') === 'true';
      $('useHL').checked = getLS('useHL', 'true') === 'true';

      // ì¡°ëª… ì„¤ì •
      $('hemiToggle').checked = getLS('hemiToggle', 'true') === 'true';
      $('dirToggle').checked = getLS('dirToggle', 'true') === 'true';
      $('hemiIntensity').value = getLS('hemiIntensity', '0.7');
      $('dirIntensity').value = getLS('dirIntensity', '1.0');
      $('sunToggle').checked = getLS('sunToggle', 'false') === 'true';
      $('sunIntensity').value = getLS('sunIntensity', '1.5');
      $('sunAzimuth').value = getLS('sunAzimuth', '135');
      $('sunAltitude').value = getLS('sunAltitude', '35');
      $('sunShadows').checked = getLS('sunShadows', 'true') === 'true';

      // ë³´ê¸° ì„¤ì •
      $('gridVis').checked = getLS('gridVis', 'true') === 'true';
      $('unitSelect').value = getLS('unitSelect', 'auto');

      // ë°°ê²½/ê·¸ë¦¬ë“œ ìƒ‰ìƒ
      $('bgColorPicker').value = getLS('bgColor', '#0f1115');
      $('gridLineColorPicker').value = getLS('gridLineColor', '#3a4153');
      $('gridMainColorPicker').value = getLS('gridMainColor', '#232531');
      $('gridSizeInput').value = getLS('gridSize', '10');
    }

    // ===== 3D ë·°ì–´ í†µì‹  í•¨ìˆ˜ (í•µì‹¬) =====
    function send3DMessage(type, data = {}) {
      console.log('Sending message:', type, data);
      
      // íŒì—…/iframe ëª¨ë“œ ìë™ ê°ì§€í•˜ì—¬ ë©”ì‹œì§€ ì „ì†¡
      if (window.opener && !window.opener.closed) {
        // íŒì—… ëª¨ë“œ: ë¶€ëª¨ ì°½(3D ë·°ì–´)ìœ¼ë¡œ ì§ì ‘ ì „ì†¡ (ë‘ ê°€ì§€ ë°©ì‹ ëª¨ë‘ ì‹œë„)
        window.opener.postMessage({
          type: 'to3DView',
          data: { type, data }
        }, '*');
        
        // ì§ì ‘ì ì¸ ë©”ì‹œì§€ë„ ë³´ë‚´ê¸°
        window.opener.postMessage({
          type: type,
          data: data
        }, '*');
      } else if (window.parent !== window) {
        // iframe ëª¨ë“œ: ë¶€ëª¨ ì°½ì„ í†µí•´ ì „ì†¡
        window.parent.postMessage({
          type: 'to3DView',
          data: { type, data }
        }, '*');
      }
    }

    // ===== ìŠ¤íƒ€ì¼ ì„¤ì • ì ìš© (ìœ¤ê³½ì„ , ì™€ì´ì–´í”„ë ˆì„ ë“±) =====
    function applyCurrentStyles() {
      const $ = id => document.getElementById(id);
      
      const styleData = {
        useOutline: $('useOutline')?.checked || false,
        outlineWidth: parseFloat($('outlineWidth')?.value || 0.02),
        outlineColor: $('outlineColor')?.value || '#111827',
        useEdges: $('useEdges')?.checked || false,
        edgesWidth: parseFloat($('edgesWidth')?.value || 15),
        edgesColor: $('edgesColor')?.value || '#000000',
        useWire: $('useWire')?.checked || false,
        useDouble: $('useDouble')?.checked || false,
        useHL: $('useHL')?.checked || false,
        metallic: parseFloat($('metallic')?.value || 0),
        roughness: parseFloat($('roughness')?.value || 0.5),
        emissive: parseFloat($('emissive')?.value || 0),
        baseColor: $('baseColor')?.value || '#ffffff',
        emissiveColor: $('emissiveColor')?.value || '#000000'
      };
      
      console.log('Applying styles:', styleData);
      send3DMessage('applyStyle', styleData);
    }

    // í˜„ì¬ ì¡°ëª… ì„¤ì • ì ìš©
    function applyCurrentLighting() {
      const $ = id => document.getElementById(id);
      
      const lightingData = {
        hemiVisible: $('hemiToggle')?.checked || false,
        hemiIntensity: parseFloat($('hemiIntensity')?.value || 1),
        dirVisible: $('dirToggle')?.checked || false,
        dirIntensity: parseFloat($('dirIntensity')?.value || 1),
        sunVisible: $('sunToggle')?.checked || false,
        sunIntensity: parseFloat($('sunIntensity')?.value || 1),
        sunAzimuth: parseFloat($('sunAzimuth')?.value || 0),
        sunAltitude: parseFloat($('sunAltitude')?.value || 45),
        sunShadows: $('sunShadows')?.checked || false
      };
      
      console.log('Applying lighting:', lightingData);
      send3DMessage('updateLighting', lightingData);
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupEventListeners() {
      const $ = id => document.getElementById(id);

      // íŒŒì¼ ë¡œë“œ
      $('file').addEventListener('change', async (e) => {
        const files = e.target.files;
        if (files && files.length) {
          const file = files[0];
          if (/\.(glb|gltf)$/i.test(file.name)) {
            // íŒì—… ëª¨ë“œì¸ì§€ í™•ì¸
            if (window.opener && !window.opener.closed) {
              // íŒì—… ëª¨ë“œ: ë¶€ëª¨ ì°½ì˜ loadFilesDirectly í•¨ìˆ˜ í˜¸ì¶œ
              window.opener.loadFilesDirectly([file]);
            } else {
              // iframe ëª¨ë“œ: ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
              const reader = new FileReader();
              reader.onload = function(event) {
                const content = btoa(String.fromCharCode(...new Uint8Array(event.target.result)));
                send3DMessage('loadModel', {
                  filename: file.name,
                  content: content
                });
              };
              reader.readAsArrayBuffer(file);
            }
          }
        }
        e.target.value = '';
      });

      // ê¸°ë³¸ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤
      $('sceneReset').onclick = () => send3DMessage('resetScene');
      $('modeMove').onclick = () => send3DMessage('setMode', { mode: 'translate' });
      $('modeRot').onclick = () => send3DMessage('setMode', { mode: 'rotate' });
      $('modeScl').onclick = () => send3DMessage('setMode', { mode: 'scale' });

      // ìŠ¤íƒ€ì¼ ë²„íŠ¼ë“¤
      $('applyStyleBtn').onclick = () => {
        console.log('Apply style button clicked');
        applyCurrentStyles();
      };
      
      $('resetStyleBtn').onclick = () => {
        console.log('Reset style button clicked');
        // ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹
        $('useOutline').checked = true;
        $('useEdges').checked = true;
        $('useWire').checked = false;
        $('useDouble').checked = false;
        $('useHL').checked = true;
        applyCurrentStyles();
      };

      // ë°°ê²½ìƒ‰ ë³€ê²½
      const bgColorPicker = $('bgColorPicker');
      console.log('bgColorPicker element:', bgColorPicker);
      if (bgColorPicker) {
        bgColorPicker.addEventListener('input', function() {
          const color = this.value;
          console.log('Background color changed to:', color);
          setLS('bgColor', color);
          send3DMessage('updateBackground', { color });
        });
      } else {
        console.error('bgColorPicker element not found!');
      }

      // ê·¸ë¦¬ë“œ ì„¤ì •
      const gridVis = $('gridVis');
      if (gridVis) {
        gridVis.addEventListener('change', function() {
          console.log('Grid visibility changed:', this.checked);
          setLS('gridVis', this.checked);
          send3DMessage('updateGrid', { visible: this.checked });
        });
      } else {
        console.error('gridVis element not found!');
      }

      const gridLineColorPicker = $('gridLineColorPicker');
      if (gridLineColorPicker) {
        gridLineColorPicker.addEventListener('input', function() {
          const color = this.value;
          console.log('Grid line color changed:', color);
          setLS('gridLineColor', color);
          send3DMessage('updateGrid', { lineColor: color });
        });
      }

      const gridMainColorPicker = $('gridMainColorPicker');
      if (gridMainColorPicker) {
        gridMainColorPicker.addEventListener('input', function() {
          const color = this.value;
          console.log('Grid main color changed:', color);
          setLS('gridMainColor', color);
          send3DMessage('updateGrid', { mainColor: color });
        });
      }

      const gridSizeInput = $('gridSizeInput');
      if (gridSizeInput) {
        gridSizeInput.addEventListener('change', function() {
          const size = parseFloat(this.value) || 10;
          console.log('Grid size changed:', size);
          setLS('gridSize', size);
          send3DMessage('updateGrid', { size });
        });
      }

      // ë‹¨ìœ„ ì„ íƒ
      $('unitSelect').addEventListener('change', function() {
        setLS('unitSelect', this.value);
      });

      // ê²€ìƒ‰ - ë©”ì‰¬ í¬ì»¤ìŠ¤
      $('search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          const name = this.value.trim();
          if (name) {
            send3DMessage('focusMesh', { name });
          }
        }
      });

      // ì¬ì§ˆ ê´€ë ¨ ì„¤ì •ë“¤ì˜ localStorage ì €ì¥ ë° 3D ë·°ì–´ ì „ë‹¬
      ['metallic', 'roughness', 'emissive'].forEach(id => {
        $(id).addEventListener('input', e => {
          setLS(id, e.target.value);
          $(id + 'Disp').textContent = parseFloat(e.target.value).toFixed(2);
          applyCurrentStyles();
        });
      });

      ['baseColor', 'emissiveColor'].forEach(id => {
        $(id).addEventListener('input', e => {
          setLS(id, e.target.value);
          applyCurrentStyles();
        });
      });

      // ìŠ¤íƒ€ì¼ ê´€ë ¨ ì„¤ì •ë“¤ì˜ localStorage ì €ì¥ ë° 3D ë·°ì–´ ì „ë‹¬
      ['useOutline', 'useEdges', 'useWire', 'useDouble', 'useHL'].forEach(id => {
        $(id).addEventListener('change', e => {
          console.log('Style setting changed:', id, e.target.checked);
          setLS(id, e.target.checked);
          applyCurrentStyles();
        });
      });

      ['outlineWidth', 'outlineColor', 'edgesWidth', 'edgesColor'].forEach(id => {
        const element = $(id);
        if (element) {
          // input ì´ë²¤íŠ¸ë¡œ ì‹¤ì‹œê°„ ì ìš©
          element.addEventListener('input', e => {
            console.log('Style setting changed:', id, e.target.value);
            setLS(id, e.target.value);
            applyCurrentStyles();
          });
        }
      });

      // ì¡°ëª… ê´€ë ¨ ì„¤ì •ë“¤ì˜ localStorage ì €ì¥ ë° 3D ë·°ì–´ ì „ë‹¬
      ['hemiToggle', 'dirToggle', 'sunToggle', 'sunShadows'].forEach(id => {
        const element = $(id);
        if (element) {
          element.addEventListener('change', e => {
            console.log('Light setting changed:', id, e.target.checked);
            setLS(id, e.target.checked);
            applyCurrentLighting();
          });
        } else {
          console.error(`Light element not found: ${id}`);
        }
      });

      ['hemiIntensity', 'dirIntensity', 'sunIntensity', 'sunAzimuth', 'sunAltitude'].forEach(id => {
        const element = $(id);
        if (element) {
          element.addEventListener('input', e => {
            console.log('Light setting changed:', id, e.target.value);
            setLS(id, e.target.value);
            applyCurrentLighting();
          });
        } else {
          console.error(`Light element not found: ${id}`);
        }
      });
    }

    // ===== ì„ íƒëœ ëª¨ë¸ ì •ë³´ íŒ¨ë„ ì—…ë°ì´íŠ¸ =====
    function updateSelectedInfoPanel(meshData) {
      const sidebar = document.getElementById('sidebar');
      let selPanel = document.getElementById('selectedInfoPanel');
      
      if (!selPanel) {
        selPanel = document.createElement('div');
        selPanel.id = 'selectedInfoPanel';
        selPanel.className = 'panel';
        sidebar.insertBefore(selPanel, sidebar.firstChild);
      }

      function vectorRow(label, vec) {
        return `<div style='margin-bottom:10px;'>
          <table style='border-collapse:collapse;width:100%;'>
            <tr><th colspan='4' style='text-align:left;font-size:13px;color:#3a4153;padding-bottom:4px;'>${label}</th></tr>
            <tr>
              <th style='width:40px;text-align:center;'>X</th>
              <th style='width:40px;text-align:center;'>Y</th>
              <th style='width:40px;text-align:center;'>Z</th>
            </tr>
            <tr>
              ${['x','y','z'].map(ax => `
                <td style='text-align:center;padding:2px;'>
                  <input type='number' step='0.01' value='${vec[ax] || 0}' data-ax='${ax}' class='vecInput' style='width:54px;'>
                  <div style='display:flex;flex-direction:row;justify-content:center;gap:2px;margin-top:2px;'>
                    <button class='btn small vecUp' data-ax='${ax}'>â–²</button>
                    <button class='btn small vecDown' data-ax='${ax}'>â–¼</button>
                  </div>
                </td>
              `).join('')}
            </tr>
          </table>
        </div>`;
      }

      selPanel.innerHTML = `<h3>ì„ íƒëœ ëª¨ë¸ ì •ë³´</h3>
        <div>ì´ë¦„: ${meshData.name || ''}</div>
        <div>id: ${meshData.id || ''}</div>
        ${vectorRow('ìœ„ì¹˜', meshData.position || {x:0,y:0,z:0})}
        ${vectorRow('ìŠ¤ì¼€ì¼', meshData.scaling || {x:1,y:1,z:1})}
        ${vectorRow('íšŒì „(ë¼ë””ì•ˆ)', meshData.rotation || {x:0,y:0,z:0})}`;
      
      selPanel.style.display = 'block';

      // ì…ë ¥ ì´ë²¤íŠ¸ ë°”ì¸ë”©
      Array.from(selPanel.querySelectorAll('.vecInput')).forEach(input => {
        input.addEventListener('change', function() {
          const ax = this.getAttribute('data-ax');
          const val = parseFloat(this.value) || 0;
          const parentLabel = this.closest('table').querySelector('th').textContent;
          
          let updateType = '';
          if (parentLabel.includes('ìœ„ì¹˜')) updateType = 'position';
          else if (parentLabel.includes('ìŠ¤ì¼€ì¼')) updateType = 'scaling';
          else if (parentLabel.includes('íšŒì „')) updateType = 'rotation';
          
          send3DMessage('updateMeshProperty', {
            name: meshData.name,
            property: updateType,
            axis: ax,
            value: val
          });
        });
      });

      // ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
      Array.from(selPanel.querySelectorAll('.vecUp, .vecDown')).forEach(btn => {
        btn.addEventListener('click', function() {
          const isUp = this.classList.contains('vecUp');
          const ax = this.getAttribute('data-ax');
          const step = 0.01;
          const td = this.closest('td');
          const input = td.querySelector(`input[data-ax='${ax}']`);
          const parentLabel = this.closest('table').querySelector('th').textContent;
          
          const currentVal = parseFloat(input.value) || 0;
          const newVal = currentVal + (isUp ? step : -step);
          input.value = newVal;
          
          let updateType = '';
          if (parentLabel.includes('ìœ„ì¹˜')) updateType = 'position';
          else if (parentLabel.includes('ìŠ¤ì¼€ì¼')) updateType = 'scaling';
          else if (parentLabel.includes('íšŒì „')) updateType = 'rotation';
          
          send3DMessage('updateMeshProperty', {
            name: meshData.name,
            property: updateType,
            axis: ax,
            value: newVal
          });
        });
      });
    }

    // ë©”ì‰¬ ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateMeshList(meshes) {
      const list = document.getElementById('list');
      const q = (document.getElementById('search').value || '').trim().toLowerCase();
      
      list.innerHTML = '';
      
      meshes
        .filter(m => (m.name || '').toLowerCase().includes(q))
        .slice(0, 200)
        .forEach(m => {
          const card = document.createElement('div');
          card.className = 'item';
          
          const head = document.createElement('div');
          head.className = 'nameLine';
          
          const nm = document.createElement('div');
          nm.className = 'name';
          nm.textContent = m.name || '(mesh)';
          
          const btns = document.createElement('div');
          btns.style.display = 'flex';
          btns.style.gap = '6px';
          
          const sel = document.createElement('button');
          sel.className = 'btn small';
          sel.textContent = 'Select';
          sel.onclick = () => send3DMessage('selectMesh', { name: m.name });
          
          const foc = document.createElement('button');
          foc.className = 'btn small';
          foc.textContent = 'Focus';
          foc.onclick = () => send3DMessage('focusMesh', { name: m.name });
          
          head.appendChild(nm);
          head.appendChild(btns);
          btns.appendChild(sel);
          btns.appendChild(foc);
          
          // ìŠ¤í… ë²„íŠ¼ë“¤
          const rRow = document.createElement('div');
          rRow.className = 'stepRow';
          ['x','y','z'].forEach(ax => {
            const mBtn = document.createElement('button');
            mBtn.className = 'btn small';
            mBtn.textContent = `R${ax.toUpperCase()}-`;
            mBtn.onclick = () => send3DMessage('stepRotate', { name: m.name, axis: ax, direction: -1 });
            
            const pBtn = document.createElement('button');
            pBtn.className = 'btn small';
            pBtn.textContent = `R${ax.toUpperCase()}+`;
            pBtn.onclick = () => send3DMessage('stepRotate', { name: m.name, axis: ax, direction: 1 });
            
            rRow.appendChild(mBtn);
            rRow.appendChild(pBtn);
          });
          
          const tRow = document.createElement('div');
          tRow.className = 'stepRow';
          ['x','y','z'].forEach(ax => {
            const mBtn = document.createElement('button');
            mBtn.className = 'btn small';
            mBtn.textContent = `T${ax.toUpperCase()}-`;
            mBtn.onclick = () => send3DMessage('stepTranslate', { name: m.name, axis: ax, direction: -1 });
            
            const pBtn = document.createElement('button');
            pBtn.className = 'btn small';
            pBtn.textContent = `T${ax.toUpperCase()}+`;
            pBtn.onclick = () => send3DMessage('stepTranslate', { name: m.name, axis: ax, direction: 1 });
            
            tRow.appendChild(mBtn);
            tRow.appendChild(pBtn);
          });
          
          card.appendChild(head);
          card.appendChild(rRow);
          card.appendChild(tRow);
          list.appendChild(card);
        });
    }

    // 3D ë·°ì–´ë¡œë¶€í„° ë°›ì€ ì„¤ì •ì„ UIì— ì ìš©
    function applySyncedSettings(settings) {
      console.log('Applying synced settings:', settings);
      
      const $ = id => document.getElementById(id);
      
      // UI ìš”ì†Œì— ì„¤ì • ì ìš©
      if (settings.bgColor && $('bgColorPicker')) $('bgColorPicker').value = settings.bgColor;
      if (settings.gridVis !== undefined && $('gridVis')) $('gridVis').checked = settings.gridVis;
      if (settings.gridLineColor && $('gridLineColorPicker')) $('gridLineColorPicker').value = settings.gridLineColor;
      if (settings.gridMainColor && $('gridMainColorPicker')) $('gridMainColorPicker').value = settings.gridMainColor;
      if (settings.gridSize !== undefined && $('gridSizeInput')) $('gridSizeInput').value = settings.gridSize;
      
      if (settings.hemiToggle !== undefined && $('hemiToggle')) $('hemiToggle').checked = settings.hemiToggle;
      if (settings.hemiIntensity !== undefined && $('hemiIntensity')) $('hemiIntensity').value = settings.hemiIntensity;
      if (settings.dirToggle !== undefined && $('dirToggle')) $('dirToggle').checked = settings.dirToggle;
      if (settings.dirIntensity !== undefined && $('dirIntensity')) $('dirIntensity').value = settings.dirIntensity;
      if (settings.sunToggle !== undefined && $('sunToggle')) $('sunToggle').checked = settings.sunToggle;
      if (settings.sunIntensity !== undefined && $('sunIntensity')) $('sunIntensity').value = settings.sunIntensity;
      if (settings.sunAzimuth !== undefined && $('sunAzimuth')) $('sunAzimuth').value = settings.sunAzimuth;
      if (settings.sunAltitude !== undefined && $('sunAltitude')) $('sunAltitude').value = settings.sunAltitude;
      if (settings.sunShadows !== undefined && $('sunShadows')) $('sunShadows').checked = settings.sunShadows;
      
      // localStorageì—ë„ ì €ì¥í•˜ì—¬ ì§€ì†ì„± í™•ë³´
      Object.keys(settings).forEach(key => {
        setLS(key, settings[key]);
      });
    }

    // ë¶€ëª¨ ì°½ìœ¼ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ 
    window.addEventListener('message', function(event) {
      const { type, data } = event.data;
      
      switch(type) {
        case 'meshSelected':
          updateSelectedInfoPanel(data);
          break;
        case 'syncSettings':
          applySyncedSettings(data);
          break;
          break;
        case 'meshListUpdate':
          updateMeshList(data.meshes);
          break;
        case 'materialListUpdate':
          // TODO: ì¬ì§ˆ ëª©ë¡ ì—…ë°ì´íŠ¸
          break;
      }
    });

    // ê²€ìƒ‰ ì…ë ¥ ì‹œ ë©”ì‰¬ ëª©ë¡ í•„í„°ë§
    document.getElementById('search').addEventListener('input', function() {
      // í˜„ì¬ ë©”ì‰¬ ëª©ë¡ì„ ë‹¤ì‹œ í•„í„°ë§í•´ì„œ í‘œì‹œ
      // ì‹¤ì œë¡œëŠ” 3D ë·°ì–´ì—ì„œ ë©”ì‰¬ ëª©ë¡ì„ ë°›ì•„ì™€ì•¼ í•¨
      send3DMessage('requestMeshList');
    });

    // íŒì—… ëª¨ë“œ ê°ì§€ ë° ì´ˆê¸°í™”
    function initializeToolbox() {
      // íŒì—… ëª¨ë“œì¸ì§€ í™•ì¸
      const isPopup = window.opener && !window.opener.closed;
      
      if (isPopup) {
        // íŒì—… ëª¨ë“œ: í—¤ë” í‘œì‹œ
        document.getElementById('popupHeader').style.display = 'block';
        document.title = '3D ë·°ì–´ ì„¤ì •';
      }
      
      restoreSettings();
      setupEventListeners();
      
      // ë©”ì‹œ ë¦¬ìŠ¤íŠ¸ ìš”ì²­
      send3DMessage('requestMeshList');
      
      // ë¶€ëª¨ ì°½ì— ì¤€ë¹„ ì™„ë£Œ ì•Œë¦¼
      if (window.parent !== window) {
        window.parent.postMessage({ type: 'toolboxReady' }, '*');
      }
      
      // íŒì—… ëª¨ë“œì—ì„œëŠ” openerì—ê²Œë„ ì•Œë¦¼
      if (isPopup) {
        window.opener.postMessage({ type: 'toolboxPopupReady' }, '*');
      }
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', initializeToolbox);
  </script>
</body>
</html>